name: CI & Nightly

permissions:
  contents: write
  packages: write

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    # Run nightly at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: {}

env:
  GO_VERSION: '1.21'
  BINARY_NAME: 'forwarding'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Verify formatting
        run: gofmt -l . | (exit 0)

      - name: Run vet
        run: go vet ./... || true

      - name: Run tests
        run: go test -v ./...

      - name: Build
        run: go build -v ./...

      - name: Test basic functionality (help output)
        run: |
          go build -o ${{ env.BINARY_NAME }} .
          # -h prints usage; no runtime service is started
          ./${{ env.BINARY_NAME }} -h | grep -q "Usage" || true

  build:
    name: Build Binaries
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')) 
    
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p dist
          BINARY_NAME="${{ env.BINARY_NAME }}"
          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi
          OUTNAME="${BINARY_NAME}-${GOOS}-${GOARCH}${EXT}"
          go build -ldflags="-s -w" -o "dist/${OUTNAME}" .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/*

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      # Checkout full history so we can create/update tags and push them
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts/ -name "${{ env.BINARY_NAME }}-*" | xargs -I {} cp {} release-assets/ || true
          ls -la release-assets/

      - name: Generate release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            TAG="nightly"
            echo "RELEASE_TAG=$TAG" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=Nightly Release $(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          else
            TAG="manual"
            echo "RELEASE_TAG=$TAG" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=Manual Release $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: Create/Update Tag
        id: create_tag
        run: |
          TAG=${{ steps.tag.outputs.RELEASE_TAG }}
          echo "Preparing tag: $TAG"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Force-create or update a single tag for nightly/manual (no history)
          git tag -f "$TAG" "${{ github.sha }}"
          git push --force origin "refs/tags/$TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.RELEASE_TAG }}
          name: ${{ steps.tag.outputs.RELEASE_NAME }}
          draft: false
          prerelease: ${{ steps.tag.outputs.IS_PRERELEASE }}
          files: release-assets/*
          body: |
            ## forwarding - TCP Port Forwarding Tool

            Pre-built binaries for the `forwarding` tool. These binaries are
            built for common platforms and architectures.

            ### Usage
            ```bash
            # Run a simple forwarder mapping public port 8080 to local service 80
            ./forwarding -p 8080:80
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
